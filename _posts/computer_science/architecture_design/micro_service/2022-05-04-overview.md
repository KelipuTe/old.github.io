---
title: "微服务概览"
create_date: 2022-05-04 08:00:00 +0800
date: 2022-05-04 08:00:00 +0800
tags: computer-science micro-service
comment: false
show_author_profile: true
show_subscribe: false
---

### 单体架构

单体架构虽然也可以使用模块化的系统设计方式，但是系统部署方式依然是整体打包后部属为单体应用。

问题点：

- 虽然使用模块化的系统设计方式，但是整个系统依然很复杂。
- 整体打包的方式无法扩容单个模块。

### 微服务架构

微服务架构采用分而治之的思路来应对单体架构的问题。将单体架构的模块拆分出来成为一个个独立的服务。这样每个服务的代码相对更少，可维护性和可测试性都更高，迭代也更容易。

特点：

- 原子化，服务遵从单一职责，服务可独立部属，服务之间互相隔离（资源隔离，数据隔离）
- 去中心化，通常每个服务都会部属多个实例，每个实例都可以提供完整的服务。
- 服务间采用轻量级通信机制。
- 服务可使用不同的技术栈（编程语言、中间件、数据库等）实现。
- 基础设施自动化（测试、部属、监控等）

注意点：

- 每个服务遵从单一职责，即每个服务只做一件事。
- 服务需要尽早创建原型，建立服务契约（接口）优先于实现。
- 服务间的通信机制，首要考虑兼容性和移植性。

问题点：

- 微服务属于分布式系统，会带来分布式系统固有的复杂性。
- 必须考虑服务间通信不稳定和服务不可用等局部失效问题。
- 分布式的存储架构和由此带来的分布式事务问题。
- 服务间的依赖，导致服务迭代时可能会涉及上下游多个服务。
- 微服务架构导致测试复杂性上升。
- 自动化依赖于运维基础设置的建设。

#### 组件服务化

传统的实现组件的方式是通过库（library），单体应用部署的时候，库是被打包在内的。这意味着，如果库发生变化，整个单体应用就需要重新部署。

通过服务来实现组件，意味着原来的库被拆出来，变成了一个或多个独立的组件服务。其他的服务只需要依赖这些组件服务即可。如果某个组件服务发生变化，只需要重新部署这个组件服务。

一个微服务架构的基本组成部分有：业务代码、kit（译：成套工具。也就是框架、中间件等基础设施）依赖、第三方依赖、轻量级通信机制。

#### 去中心化

每个服务互相隔离，拥有自己的资源和数据，这样有利于服务的独立性，防止服务之间互相干扰。通常每个服务都会部属多个实例，每个实例都可以提供完整的服务。这样不用担心，某一个服务实例不可用，会造成整个系统不可用。

每个服务面临的场景不同，可以针对性的选择合适的技术栈和解决方案。也就是可以部署在最合适的硬件上，使用最合适的编程语言，使用最合适的数据存储结构。但是也需要避免过度多样化带来的维护成本问题。

#### 服务发现

微服务意味着去中心化，去中心化意味着，服务消费者（consumer）需要通过服务发现机制去找到可以提供服务的服务提供者（provider）。

服务发现有两种模式，客户端发现和服务端发现，两种模式各有优劣。客户端发现：一个服务提供者启动时会到注册中心去注册，服务消费者通过和注册中心建立心跳获取服务提供者列表，然后使用负载均衡算法访问服务提供者。服务端发现：服务消费者直接访问注册中心，由注册中心查询服务提供者列表，然后使用负载均衡算法进行转发。

客户端发现的好处是，相比服务端发现，少一次网络跳转，但是服务消费者需要内置服务发现相关的逻辑。服务端发现的好处是，服务消费者无需关注服务发现的细节，相当于解耦了，但是多了一次网络跳转，而且注册中心的存在会引入中心化。

当微服务系统的服务数量过大时，服务发现组件使用 CP 策略基本就不可行了，海量的节点加上网络抖动不可能做到一致性，这时就需要使用 AP 策略，保证可用的同时最大限度保证最终一致性。

服务在去注册中心注册的时候还可以附加很多的元数据：权重、集群、染色标签等。这样其他服务就可以主动识别这些元数据然后进行分流操作，可用于多集群和多租户的场景。

常见的服务发现组件：web service 的注册中心、ZooKeeper 等。

##### 多集群

传统的方案，对于重要的服务通常会部属一套大集群。但是大集群一旦故障，影响范围就会很大。从单一大集群的可用性的角度考虑，可以部属冗余的节点增加集群的可用性。从单一大集群故障的角度考虑，可以考虑将单一大集群拆分成多个集群，以冗余集群的方式增加整个系统的可用性。多集群物理上被拆成了多个集群部属，但是逻辑上属于一个集群。多集群中不同的集群可以使用不同的缓存资源，这可以提供更好的性能和更高的可用性。

这里还有机房的问题，机房也会发生故障。如果单一大集群或者多集群都部属在一个机房内，机房故障依然会导致服务不可用。这个时候就可以使用多机房，也就是异地多活的部署方式。

多集群在使用过程中可以通过在元数据中添加集群信息的方式，区分某个服务属于一个逻辑集群下的多集群中的哪个集群，这样就可以实现让指定的服务消费者访问多集群中的指定集群。这是一种隔离的思路，但是这么做是有隐患的，业务的隔离会导致缓存数据分化，当这个集群出故障需要切换流量到别的集群时，容易出现缓存穿透（cache miss）。

对于重要的服务合适的做法是，在元数据中添加集群信息，但是多集群当一个逻辑集群用。这样缓存就是均匀分布的，需要切换流量时就不会有问题。当某个集群故障时，也可以通过元数据识别并剔除。

实际业务中没有绝对的哪种做法就是好的，一切都需要具体问题具体分析。

##### 多租户

多租户（multi-tenancy）：在一个微服务架构中允许多系统共存。多租户是利用微服务稳定性以及模块化最有效的方式之一。使用租户能够保证代码的隔离性并且能够基于流量租户做路由决策。租户可以是测试系统，灰度（金丝雀）发布，影子系统（shadow systems）等。对于传输中的数据（data in flight），如外部请求、静态数据（data at rest）、缓存、持久化存储的数据，租户都能够保证隔离性和公平性。

通常来说，微服务架构有两种基本的集成测试方式：并行测试和生产环境测试。并行测试需要一个和生产环境一样的过渡（staging）环境，并且只是用来处理测试流量。这种方法可以在不影响生产环境的情况下让开发者稳定地测试服务，同时能够在发布前更容易识别和控制 bug。并行测试是一种非常有效的集成测试方法，但是在微服务换架构中，存在一些问题。

- 如果只部属一套系统，每个团队都在测试自己的服务，混用环境导致无法测试。如果部属多套系统，则会带来很高的硬件成本。
- 测试环境模拟多套系统时，难以模拟线上真实流量，做负载测试（压力测试）。

解决方案是染色发布（这里随便翻译一下：color release）。可以把待测试服务在一个隔离的沙盒环境中启动，并且让它可以访问集成环境（测试、生产）。集成环境的正常流量保持不变，确保正常流量不被测试流量影响。同时可以把测试流量从集成环境路由到沙盒环境，沙盒环境只处理测试流量。

<div style="text-align: center">
<img src="/image/color_release.drawio.png">
</div>

灰度测试是有代价的，哪怕是一个节点，也承载了一部分的流量。在生产环境中的测试有两个基本要求，它们也构成了多租户体系结构的基础。

- 隔离性：能够可靠地隔离测试和生产中的资源。
- 流量路由：能够基于识别流量类型并路由到对应的服务中去。

给入站请求绑定上下文，跨服务使用元数据（metadata）传递。在整个架构中每一个基础组件都能够理解租户信息，并且能够基于租户路由隔离流量，同时平台允许控制不同的微服务模块，比如指标和日志。在微服务架构中典型的基础组件是日志、指标、存储、消息队列、缓存以及配置。基于租户信息隔离数据需要分别处理基础组件。

多租户架构本质上描述为：跨服务传递请求携带上下文（context），数据隔离的流量路由方案。利用服务发现注册租户信息，注册成特定的租户。

#### 轻量级通信机制

Go 可以使用 gRPC 组件实现轻量级通信机制。

#### 基础设施自动化

微服务架构一定伴随基础设施自动化。单体架构被拆分微服务架构后，意味着开发、调试、测试、部署、监控的复杂度都会增加。必须要有合适的自动化基础设施来支持微服务架构，否则增加的就是开发、运维成本。

CI/CD 方法，CI（continuous integration，持续集成），把代码仓库、构建⼯具、测试⼯具集成在⼀起，频繁的将代码合并到主⼲然后⾃动进⾏构建和测试。CD（continuous delivery，持续部署）CD 是在 CI 的基础上进⾏扩展。在 CI 环节完成软件构建和测试⼯作并形成新的版本的服务后，将服务交付到类⽣产环境（staging、灰度环境、预发布环境），接受部分真实流量的测试。如果没有问题的话，则通过⼿动的⽅式部署到⽣产环境（production）。

DevOps 是一组过程、方法与系统的统称，用于 Dev（软件开发人员）、Ops（IT 运维技术人员）、QA（质量保障部门）之间的沟通、协作与整合。透过自动化的流程，使得构建、测试、发布软件能够更加地快捷、频繁和可靠。

#### 可用性和兼容性

可用性：微服务架构让原本在单体架构内部的进程间通信，变成了网络间进程间通信，引入了额外的复杂度和新的问题（负载均衡、网络延迟、通信机制、容错等）。所以必须有 design for failure 的思想，隔离、负载均衡、超时控制、过载保护、限流、降级、重试等都需要考虑到。

兼容性：一旦采用了微服务架构模式，那么服务提供者的变更可能引发服务消费者的兼容性破坏，需要注意保持服务契约（接口）的兼容性。

### 微服务设计

#### 统一入口

微服务需要一个统一入口对外暴露内部服务。

没有个统一入口时会产生的问题：

- 客户端直接访问内部服务，造成强耦合。
- 客户端获取复杂数据时需要请求多个服务。
- 内部服务的实现可能不一样，对外接口的协议和格式不统一。
- 内部服务需要处理不同客户端的适配和兼容工作（针对用户端和管理端的数据裁剪等）。
- 统一的逻辑（路由、鉴权、安全、限流等）分布于各个内部服务，无法收敛。

个统一入口可以解决的问题：

- 隔离客户端和内部服务，这样升级内部服务就会比较容易。
- 客户端获取复杂数据时，可以由网关来进行数据的聚合工作。
- 内部服务不同的通信协议和数据格式可以在网关统一转换。
- 不同客户端的适配和兼容工作可以由网关进行，网关可以根据不同的客户端提供定制化的 API。
- 网关提供统一逻辑（路由、鉴权、安全、限流等），内部服务只能通过内网访问。

个统一入口可以再拆分为 API Gateway（网关） 和 BFF（backend for frontend，聚合层）。API Gateway 负责处理跨横切面（cross-cutting concerns）的功能（路由、鉴权、安全、限流等）。BFF 专注于业务逻辑。外部请求先通过负载均衡访问网关，网关进行统一的认证和拦截。通过网关后，认证信息会放在请求元数据中（HTTP 头部等），然后访问 BFF，由 BFF 扇出访问内部服务。

#### 服务划分

服务划分的方式多种多样：可以根据业务划分；可以使用 CQRS 的方式划分，即命令端（写）和查询端（读）；或者其他合适的分划分方法。

### 参考

- 极客时间：Go 进阶训练营
- 搜索：服务发现
- 搜索：分布式系统 CAP
- - [分布式系统的CAP定理详解](https://zhuanlan.zhihu.com/p/335617791)
- 搜索：CI/CD
- - [CI/CD 方法](https://zhuanlan.zhihu.com/p/228272483)
- 搜索：DevOps
- - [什么是DevOps？](https://www.zhihu.com/question/58702398)
