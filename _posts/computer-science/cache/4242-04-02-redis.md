---
title: "Redis"
date: 2022-06-01 08:00:00 +0800
tags: computer-science 计算机科学 cache 缓存
comment: false
show_author_profile: true
show_subscribe: false
---

### Redis

支持丰富的数据类型。

- 集合和数组结构可用于数据索引。如：排行榜元素的 ID，关系列表元素的 ID 等。
- 数组结构还可用于实现队列的功能。如：作为消息队列使用等。

### 线程模型

早期使用的是单线程模型，后来使用的是双线程模型，一个线程负责处理父子 IO，一个线程负责处理数据读写。

处理大 value 的时候，因为单线程工作，后续的操作进不来，整体吞吐会明显下降。

### 内存模型

因为没有使用内存池的设计，所以存在一定的内存碎片。

提供了 jemalloc 用于优化内存分配，编译的时候默认使用 jemalloc 代替 glib 库的 malloc。

### Slot

Redis Cluster 采用数据分片机制，定义了 16384 个 Slot（槽），集群中的每个 Redis 实例负责维护一部分槽以及槽所映射的键值数据。使用时，先计算数据的 key 应该映射到哪个槽上，再根据槽找到对应的节点。

当进行扩容、缩容时，每个节点都会提供、托管一部分槽。这样在数据迁移时，压力不会集中在某个节点上。

### 缓存技巧

- 批量读取，批量写入
- redis 的 value 能用 int 就不要用 string。

redis 底层有 shared_object 缓存，比如如果多个 key 的 value 都是 1，那么底层共用同一个变量就行了，不需要每个 key 都自己存一个。

- bitset、bitmap（位图）
- 增量更新一致性

比如 zadd 一个新的 id 到 set 中时，如果本来这个 set 有 100 个 id 的，正好过期了，还没来得及刷新，这时 zadd 就会变成新建一个 set 然后只有 1 个 id 了。

这种情况可以先尝试续期这个 set，如果续期成功，就添加 id；如果续期不成功，就触发回填。

- list

比如秒杀场景。预先把奖池进行切割，打散后放到几个 list 里面去。用户的请求进来时，先通过概率直接筛掉一部分请求，通过的请求随机选一个 list，然后 pop 一个奖品出来。这样就不用去访问数据库了，可以等活动结束之后在更新数据库。

- 避免各种类型的大 value，不只是大 string，元素数量很多的 set 等也是大 value。
- setnx 可用于分布式锁。

### 参考

- 极客时间：Go 进阶训练营
