---
title: "计算机科学--数据库--MySQL--Data Page（数据页）"
create_date: 2022-05-23 08:00:00 +0800
date: 2022-05-23 08:00:00 +0800
tags: computer-science database mysql
comment: false
show_author_profile: true
show_subscribe: false
---

### InnoDB

MySQL 数据表中的记录是按照行存储的，这些记录最终是要存储到硬盘中去的。硬盘的运行速度和内存的运行速度有巨大的差距。如果每次进行硬盘 IO 的时候只处理一行的记录，这样的效率是很低的。因此 MySQL 进行硬盘 IO 的时候不以行为单位。

MySQL 支持多种存储引擎，不同的存储引擎，存储数据的方式不同。其中 InnoDB 存储引擎进行硬盘 IO 的时候就是以 Data Page（数据页）为单位而不是以行为单位。InnoDB 的数据页的默认大小是 16KB，也就是每次读写硬盘的时候一次都是处理 16KB 的数据。

### 数据页

数据页包含七个部分：

| 名称 | 大小（byte） | 用途 |
| --- | --- | --- |
| File Header（文件头） | 38 | 页的信息 |
| Page Header（页头） | 56 | 页的状态信息 |
| Infimun Supremum（最小记录和最大记录） | 26 | 页中的最小记录和最大记录 |
| User Records（用户记录） | ? | 数据表的行记录 |
| Free Space（空闲空间） | ? | 页中还没被使用的空间 |
| Page Directory（页目录） | ? | 存储用户记录的相对位置 |
| File Trailer（文件尾） | 8 | 校验页是否完整 |

- 文件头里有两个指针，分别指向上一个数据页和下一个数据页，数据页之间构成一个双向链表。
- 数据表中的记录，按照主键，顺序组成单链表，存储在用户记录里。
- 页目录起索引的作用，查找某条记录时不用整个遍历用户记录里的单链表。

### 页目录的创建过程

- 1、将所有的记录（不包括"已删除"）划分成几个记录组
- 2、每个记录组的最后一条记录的头信息中会存储该组一共有多少条记录。
- 3、页目录按照先后顺序存储每个记录组的最后一条记录的地址偏移量。地址偏移量也称为 slot（槽），槽相当每个记录组的索引。

因为用户记录中的行记录是按照主键从小到大排序的，所以页目录中的槽也是有序的。查找某条记录时，可以使用二分法快速定位要查询的记录在哪个槽，然后遍历槽内的所有记录，就可以找打对应的记录。

InnoDB 对每个分组中的记录条数都是有规定的：

- 第一个分组中的记录只能有 1 条记录
- 最后一个分组中的记录条数范围只能在 1~8 条之间
- 剩下的分组中记录条数范围只能在 4~8 条之间

### 查询

数据页中的页目录提高了页内记录的查询速度，但是大量的记录，一个数据页是存不下的，需要大量的数据页。因此需要通过合适的索引结构来高效确定查询的记录在哪个数据页上。

MySQL 的索引也是保存到硬盘上的，当通过索引查找某行记录时，需要先从硬盘读取索引到内存。通过索引找到记录在哪个数据页上，然后从硬盘中读取那个数据页到内存，最终从数据页中找到那条记录。查询过程中会发生多次硬盘 IO，硬盘 IO 次数越多，整体查询时间就越长。

磁盘（硬盘）的最小读写单位是扇区，扇区的大小是 512B。操作系统的最小读写单位是 Block（块），就是一次会读写多个扇区。在 Linux 中，一次磁盘 IO 操作会读写 8 个扇区，也就是块大小为 4KB。

InnoDB 采用了 B plus tree（B+ 树）作为索引。B+ 树有利于减少硬盘 IO 的次数，而且 B+ 树适合进行关键字的范围查询。B+ 树中的每个结点都是一个数据页，非叶子结点的数据页仅用来存放数据页的索引，只有叶子结点的数据页才存放数据。所有叶子结点按照索引键排序，构成一个双向链表，便于范围查询。

查询某条记录的时候，先通过非叶子结点，定位到要找的记录在哪个叶子结点上。然后再在叶子结点的数据页中找到那条记录的详细数据。