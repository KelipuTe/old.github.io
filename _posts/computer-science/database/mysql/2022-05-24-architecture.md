---
title: "Architecture（架构）"
create_date: 2022-05-24 08:00:00 +0800
date: 2022-05-24 08:00:00 +0800
tags: computer-science database mysql
comment: false
show_author_profile: true
show_subscribe: false
---

### 架构

MySQL 大体上可分为 server（服务层）和 storage engine（存储引擎层）两部分。

- 服务层包括连接器、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能。
- 存储引擎层负责数据的存储和提取。支持 InnoDB、MyISAM、Memory 等多个存储引擎。

### 连接器

连接器的工作是，跟客户端建立连接、获取权限、维持和管理连接。

连接命令一般是这么写的：`mysql -h$ip -P$port -u$user -p`。输完命令之后输入密码。虽然密码可以直接跟在 -p 后面，但这样可能会导致密码泄露。如果连的是生产服务器，强烈建议不要这么做。

连接命令中的 `mysql` 是客户端工具，用来跟服务端建立连接。在完成经典的 TCP 握手后，连接器就要开始认证身份，这个时候用的就是输入的用户名和密码。

如果用户名或密码不对，会收到一个 `Access denied for user` 的错误，然后客户端程序结束执行。如果用户名密码认证通过，连接器会到权限表里面查出拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。

需要注意的是 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。如果大量的 TCP 长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM）。

如果用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。会将连接恢复到刚刚创建完时的状态，但是不需要重连和重新做权限验证。

客户端如果太长时间没动静，连接器就会自动将它断开。如果在连接被断开之后，客户端再次发送请求的话，就会收到一个错误提醒：`Lost connection to MySQL server during query`。

### 分析器

分析器的工作是，对 SQL 语句做解析，搞清楚要做什么。

分析器先会做词法分析，识别出 SQL 里面的字符串是什么。

然后做语法分析，根据语法规则，判断 SQL 是否满足 MySQL 语法。如果语句不对，就会收到 `You have an error in your SQL syntax` 的错误提醒。一般语法错误会提示第一个出现错误的位置。

### 优化器

优化器的工作是，为 SQL 语句确定一个执行方案，提高执行的效率。

- 当表里面有多个索引的时候，决定使用哪个索引。
- 在一个语句有多表关联（join）的时候，决定各个表的连接顺序。

### 执行器

执行器的工作是，执行 SQL 语句最终的执行方案。

开始执行的时候，要先判断一下对这个表有没有执行查询的权限。如果没有，就会返回没有权限的错误。如果有，就打开表继续执行。打开表的时候，执行器会根据表定义的引擎，去使用这个引擎提供的接口。
