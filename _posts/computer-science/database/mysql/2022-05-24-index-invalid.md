---
title: "计算机科学--数据库--MySQL--Index Invalid（索引失效）"
create_date: 2022-05-24 08:00:00 +0800
date: 2022-05-24 08:00:00 +0800
tags: computer-science database mysql
comment: false
show_author_profile: true
show_subscribe: false
---

### like

使用 `like '%xxx'` 或者 `like '%xxx%'` 的时候索引会失效。因为索引树是按照索引值有序排列的，只能进行前缀比较。

但是有个特殊的情况，如果查询的字段全部在索引树中，这个时候虽然索引失效了，但是依然会用到索引树，通过直接扫描整个索引树拿到需要的数据。因为聚簇索引树保存了全部的数据，它一定比二级索引树大，所以扫描二级索引树会快一点。

### 对索引进行表达式计算

如果 id 字段有索引，那么 `where id + 1 = 10` 语句就用不到索引，因为索引保存的是索引字段的原始值，对索引进行表达式计算后的值不一定在索引里，只能全表扫描。但是 `where id = 10 - 1` 语句就可以用到索引。

### 索引隐式类型转换

MySQL 在遇到字符串和数字比较的时候，会自动把字符串转为数字，然后再进行比较。`select '10' > 9; // 结果是 1` 通过这个例子就可以测试转换规则。

当索引字段是字符串的时候，如果 sql 语句是 `where 索引字段 = 123`，这时就会把索引字段转换成数字，也就不走索引了。

当索引字段是数字的时候，如果 sql 语句是 `where 索引字段 = '123'`，这时就会把 `'123'` 转换成数字，这个时候就走索引。

### 联合索引非最左匹配

如果创建了一个联合索引 (a,b,c)。那么：

- `where a=1`、`where a=1 and b=2`、`where a=1 and b=2 and c=3` 都能用到索引。
- `where b=2`、`where c=3`、`where b=2 and c=3` 都用不到索引。
- 特别的 `where a=1 and c=3` 是能用到索引的，不过只能用到 a 的索引。这种属于索引截断。

索引截断，对于 MySQL 5.6 之后的版本，有一个索引下推功能。索引下推可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。如果用到了索引下推，那么 explain 的结果里的 extra 字段会显示 `Extra=Using index condition`。

### or

如果在 or 前的条件列是索引列，而在 or 后的条件列不是索引列，那么索引会失效。因为 or 的含义就是两个只要满足一个即可，因此只有一个条件列是索引列是没有意义的，只要有条件列不是索引列，就会进行全表扫描。