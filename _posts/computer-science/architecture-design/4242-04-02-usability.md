---
title: "可用性"
date: 2022-05-29 08:00:00 +0800
tags: computer-science 计算机科学 architecture-design 架构设计
comment: false
show_author_profile: true
show_subscribe: false
---

### 可用性

可用性（usability）：在某个考察时间，系统能够正常运行的概率。考察时间为指定瞬间，则称瞬时可用性；考察时间为指定时段，则称时段可用性。

### 隔离->[站内链接]({% link _posts/computer-science/architecture-design/4242-04-02-isolation.md %})

### 超时控制

超时控制的目的是让某一个操作能够快速失效（fail fast），

#### 进程内

不合理的结构（逻辑结构和数据结构）或者不合理的算法造成执行耗时很长。

#### 进程间

主要是单机进程间通信超时和网络间进程间通信超时。

对于数据库来说网络间进程间通信超时还可以分为连接超时（网络不稳定等）、读超时（查询没有索引等）、写超时（插入和更新被锁等）。

可以通过超时传递

#### 双峰分布->[站内链接]({% link _posts/mathematics/statistics/4242-04-02-bimodal-distribution.md %})

### 过载保护和限流

过载保护的目的：

- 在系统稳定的前提下，最大限度保持系统的吞吐量。
- 在系统临近过载时，主动限流（抛弃请求），以求自保。

需要注意的是，抛弃（拒绝）请求也是需要成本的，有过载保护系统依然有可能被大量请求的网络连接打崩溃。

#### 自适应限流

在系统临近负载时（CPU 达到 90%、内存达到 90% 等），使用利特尔法则测量系统理论最大流量的滑动平均值，然后依次为基准进行限流。

利特尔法则：$L = λ \times W$，其中 L 为流量；λ 为流速；W 为时间跨度。$600ml = 10 ml/s * 60s$ 表示 $60 秒的总水流量 = 10 毫升每秒 * 60 秒$。

$系统每秒理论最大流量 = 每秒查询率（QPS） \time·s 请求平均响应时间$，三个值都是滑动平均值。

#### 分布式限流

简单的实现：每来一个请求，redis +1。

复杂一点的实现：每次心跳，从限流中心（限流器）批量申请配额（quota）。本地可以统计 QPS 的滑动平均值来决定每次申请多少配额。拿到配额后本地用令牌桶。

分配配额的方式：最大最小公平分享（Max-Min Fairness）

- 资源按照需求递增的顺序进行分配。
- 不存在用户得到的资源超过自己的需求。
- 未得到满足的用户等价的分享资源。

底层组件（数据库等）一定要做分布式限流。

#### 根据优先级限流

根据优先级限流可以和自适应限流和分布式限流配合使用。

- 达到某个负载时，先丢弃低优先级的请求（自适应限流）。
- 分配配额时，高优先级可以优先满足（分布式限流）。

#### 熔断

熔断是对下游的保护。如果熔断器（断路器、Circuit Breakers）发现下游服务大量报错，就不继续请求下游，而是直接返回定义好的错误。因为下游拒绝请求也需要消耗资源，如果上游因为失败不停的重试，有雪球效应可能会让下游过载。

当下游采用双机热备的成本和效益不匹配时，可以额外搭建一个小集群，承接主集群熔断时，多余的流量。当主机群恢复后，再切回去。

客户端需要对用户的积极的重试进行控制。

### 降级

降级本质为提供有损服务。

### 重试

- 重试次数：限制重试次数，防止请求一直占用资源
- 重试周期：随机化、指数型递增，防止重试请求叠出峰来
- 只在失败处重试：底层重试过了，上层就不要重试了，避免级联重试

### 负载均衡->[站内链接]({% link _posts/computer-science/architecture-design/4242-04-02-load-balance.md %})

### 参考

- 极客时间：Go 进阶训练营
